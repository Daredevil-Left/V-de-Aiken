<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Coeficiente V de Aiken</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-radius: 50%;
            border-top: 5px solid #3498db;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 p-4 sm:p-6 md:p-8">
    <div class="max-w-7xl mx-auto">

        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-slate-900">Calculadora de Coeficiente V de Aiken</h1>
            <p class="mt-2 text-lg text-slate-600">Una herramienta para validar la pertinencia de ítems mediante juicio de expertos.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Columna de Configuración y Acciones -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Card de Configuración -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold mb-4 border-b pb-2 flex items-center">
                        <i class="fas fa-cogs mr-2 text-indigo-500"></i> 1. Configuración
                    </h2>

                    <div class="space-y-4">
                        <div>
                            <label for="numJueces" class="block text-sm font-medium text-slate-700 mb-1">Número de Jueces</label>
                            <input type="number" id="numJueces" value="5" min="2" class="w-full p-2 border border-slate-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="numItems" class="block text-sm font-medium text-slate-700 mb-1">Número de Ítems</label>
                            <input type="number" id="numItems" value="10" min="1" class="w-full p-2 border border-slate-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <button id="btnGenerarTabla" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors flex items-center justify-center">
                            <i class="fas fa-table mr-2"></i>Generar Tabla de Datos
                        </button>
                    </div>
                </div>

                <!-- Card de Escala de Valoración -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold mb-4 border-b pb-2 flex items-center">
                        <i class="fas fa-ruler-combined mr-2 text-teal-500"></i> 2. Escala de Valoración
                    </h2>
                    <div id="escalaContainer" class="space-y-2">
                        <!-- Las opciones de la escala se generarán aquí -->
                    </div>
                    <button id="btnAgregarOpcion" class="mt-4 text-sm bg-teal-500 text-white font-semibold py-2 px-3 rounded-lg hover:bg-teal-600 transition-colors flex items-center">
                        <i class="fas fa-plus mr-2"></i>Añadir Opción
                    </button>
                </div>

                 <!-- Card de Acciones -->
                 <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold mb-4 border-b pb-2 flex items-center">
                        <i class="fas fa-play-circle mr-2 text-emerald-500"></i> 3. Acciones
                    </h2>
                    <div class="space-y-3">
                        <button id="btnCalcular" class="w-full bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-emerald-700 transition-colors flex items-center justify-center">
                            <i class="fas fa-calculator mr-2"></i>Calcular V de Aiken
                        </button>
                         <button id="btnGuardar" class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors flex items-center justify-center">
                            <i class="fas fa-save mr-2"></i>Guardar Progreso
                        </button>
                        <button id="btnCargar" class="w-full bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center">
                            <i class="fas fa-upload mr-2"></i>Cargar Progreso
                        </button>
                        <button id="btnLimpiar" class="w-full bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors flex items-center justify-center">
                            <i class="fas fa-trash mr-2"></i>Limpiar Todo
                        </button>
                    </div>
                </div>
            </div>

            <!-- Columna de Datos y Resultados -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Card de Ingreso de Datos -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                     <h2 class="text-xl font-bold mb-4 border-b pb-2 flex items-center">
                        <i class="fas fa-edit mr-2 text-sky-500"></i> Ingreso de Datos de Jueces
                    </h2>

                    <!-- NUEVA SECCIÓN DE CARGA EXCEL -->
                    <div class="mb-6 p-4 border border-dashed rounded-lg bg-slate-50">
                        <label for="uploadExcel" class="block text-sm font-medium text-slate-700 mb-2">
                            Opcional: Cargar datos desde un archivo Excel (.xlsx, .xls)
                        </label>
                        <input type="file" id="uploadExcel" accept=".xlsx, .xls, .csv" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                        <p class="text-xs text-slate-500 mt-2">
                            <i class="fas fa-info-circle mr-1"></i>
                            El archivo debe tener los ítems en filas y los jueces en columnas. La primera fila son los encabezados de los jueces y la primera columna los ítems.
                        </p>
                    </div>
                    <!-- FIN NUEVA SECCIÓN -->

                    <div id="tablaContainer" class="overflow-x-auto">
                        <p class="text-slate-500">Por favor, genere la tabla de datos o cargue un archivo Excel.</p>
                    </div>
                </div>

                <!-- Card de Resultados -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold mb-4 border-b pb-2 flex items-center">
                        <i class="fas fa-chart-bar mr-2 text-purple-500"></i> Resultados del Análisis
                    </h2>
                    <div id="spinner" class="hidden justify-center items-center py-8">
                        <div class="loader"></div>
                        <p class="ml-4 text-slate-600">Calculando...</p>
                    </div>
                    <div id="resultadosContainer" class="overflow-x-auto">
                        <p class="text-slate-500">Los resultados aparecerán aquí después de realizar el cálculo.</p>
                    </div>
                    <button id="btnDescargarPDF" class="hidden mt-6 bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors flex items-center justify-center">
                        <i class="fas fa-file-pdf mr-2"></i>Descargar Resultados en PDF
                    </button>
                </div>
            </div>
        </div>

        <footer class="text-center mt-12 text-slate-500">
            <p>&copy; 2024 Creado con Gemini. Herramienta de análisis psicométrico.</p>
        </footer>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Elementos del DOM
        const numJuecesEl = document.getElementById('numJueces');
        const numItemsEl = document.getElementById('numItems');
        const btnGenerarTabla = document.getElementById('btnGenerarTabla');
        const tablaContainer = document.getElementById('tablaContainer');
        const escalaContainer = document.getElementById('escalaContainer');
        const btnAgregarOpcion = document.getElementById('btnAgregarOpcion');
        const btnCalcular = document.getElementById('btnCalcular');
        const resultadosContainer = document.getElementById('resultadosContainer');
        const btnDescargarPDF = document.getElementById('btnDescargarPDF');
        const spinner = document.getElementById('spinner');
        const uploadExcelEl = document.getElementById('uploadExcel');
        const btnGuardar = document.getElementById('btnGuardar');
        const btnCargar = document.getElementById('btnCargar');
        const btnLimpiar = document.getElementById('btnLimpiar');

        // Estado inicial de la escala
        let escalaOpciones = [
            { texto: 'Deficiente', valor: 1 },
            { texto: 'Regular', valor: 2 },
            { texto: 'Buena', valor: 3 },
            { texto: 'Muy buena', valor: 4 },
            { texto: 'Excelente', valor: 5 }
        ];

        // --- FUNCIONES DE LA ESCALA ---
        const renderizarEscala = () => {
            escalaContainer.innerHTML = '';
            escalaOpciones.forEach((opcion, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center space-x-2';
                div.innerHTML = `
                    <input type="text" value="${opcion.texto}" class="w-2/3 p-1 border border-slate-300 rounded-md" data-index="${index}" data-tipo="texto" placeholder="Etiqueta (e.g., Bueno)">
                    <input type="number" value="${opcion.valor}" class="w-1/3 p-1 border border-slate-300 rounded-md" data-index="${index}" data-tipo="valor" placeholder="Valor">
                    <button class="text-red-500 hover:text-red-700" data-index="${index}"><i class="fas fa-trash-alt"></i></button>
                `;
                escalaContainer.appendChild(div);
            });
             // Refrescar las opciones de los selects si la tabla ya existe
            if (tablaContainer.querySelector('table')) {
                generarTabla();
            }
        };

        escalaContainer.addEventListener('change', (e) => {
            if (e.target.tagName === 'INPUT') {
                const index = parseInt(e.target.dataset.index);
                const tipo = e.target.dataset.tipo;
                escalaOpciones[index][tipo] = tipo === 'valor' ? parseFloat(e.target.value) : e.target.value;
            }
        });

        escalaContainer.addEventListener('click', (e) => {
            if (e.target.closest('button')) {
                const index = parseInt(e.target.closest('button').dataset.index);
                escalaOpciones.splice(index, 1);
                renderizarEscala();
            }
        });

        btnAgregarOpcion.addEventListener('click', () => {
            const maxVal = escalaOpciones.length > 0 ? Math.max(...escalaOpciones.map(o => o.valor)) : 0;
            escalaOpciones.push({ texto: '', valor: maxVal + 1 });
            renderizarEscala();
        });

        // --- FUNCIONES DE LA TABLA DE DATOS ---
        const generarTabla = () => {
            const numJueces = parseInt(numJuecesEl.value);
            const numItems = parseInt(numItemsEl.value);

            if (isNaN(numJueces) || isNaN(numItems) || numJueces <= 0 || numItems <= 0) {
                tablaContainer.innerHTML = '<p class="text-red-500">Por favor, ingrese un número válido de jueces e ítems.</p>';
                return;
            }

            let tableHTML = '<table class="min-w-full divide-y divide-slate-200 border border-slate-200"><thead><tr class="bg-slate-50">';
            tableHTML += '<th class="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Ítem</th>';
            for (let j = 1; j <= numJueces; j++) {
                tableHTML += `<th class="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Juez ${j}</th>`;
            }
            tableHTML += '</tr></thead><tbody class="bg-white divide-y divide-slate-200">';

            for (let i = 1; i <= numItems; i++) {
                tableHTML += `<tr><td class="px-4 py-2 whitespace-nowrap font-medium text-sm">Ítem ${i}</td>`;
                for (let j = 1; j <= numJueces; j++) {
                    tableHTML += `<td class="px-4 py-2"><input type="number" class="w-full p-1 border border-slate-300 rounded-md" data-item="${i}" data-juez="${j}" placeholder="Valor"></td>`;
                }
                tableHTML += '</tr>';
            }
            tableHTML += '</tbody></table>';

            const valoresPermitidos = escalaOpciones.sort((a, b) => a.valor - b.valor).map(opc => `<strong>${opc.valor}</strong>: ${opc.texto}`).join(', ');
            tableHTML += `<div class="mt-4 text-sm text-slate-600"><i class="fas fa-info-circle mr-1"></i> Ingrese los valores numéricos correspondientes a la escala: ${valoresPermitidos}.</div>`;

            tablaContainer.innerHTML = tableHTML;
        };

        btnGenerarTabla.addEventListener('click', generarTabla);

        // --- FUNCIÓN PARA MANEJAR LA CARGA DE ARCHIVOS EXCEL ---
        const handleFileUpload = (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    if (jsonData.length < 2 || jsonData[0].length < 2) {
                        throw new Error("El archivo Excel no tiene el formato esperado. Debe tener al menos 1 ítem y 1 juez.");
                    }

                    const loadedItems = jsonData.length - 1;
                    const loadedJueces = jsonData[0].length - 1;

                    numItemsEl.value = loadedItems;
                    numJuecesEl.value = loadedJueces;
                    generarTabla();

                    for (let i = 1; i <= loadedItems; i++) { // Fila de datos (ítem)
                        for (let j = 1; j <= loadedJueces; j++) { // Columna de datos (juez)
                            const cellValue = jsonData[i][j];
                            if (cellValue === undefined || cellValue === null) continue;

                            const input = tablaContainer.querySelector(`input[data-item="${i}"][data-juez="${j}"]`);
                            if (!input) continue;

                            const cellText = String(cellValue).trim().toLowerCase();
                            const cellNumber = parseFloat(cellValue);

                            // Priorizar la búsqueda por valor numérico si es un número válido
                            if (!isNaN(cellNumber) && escalaOpciones.some(opc => opc.valor === cellNumber)) {
                                input.value = cellNumber;
                            } else {
                                // Si no, buscar por texto
                                const option = escalaOpciones.find(opc => opc.texto.toLowerCase() === cellText);
                                if (option) {
                                    input.value = option.valor;
                                }
                            }
                        }
                    }
                    alert('¡Datos cargados desde Excel exitosamente!');

                } catch (error) {
                    alert(`Error al procesar el archivo: ${error.message}`);
                } finally {
                    e.target.value = ''; // Permite recargar el mismo archivo
                }
            };
            reader.readAsArrayBuffer(file);
        };
        uploadExcelEl.addEventListener('change', handleFileUpload);

        // --- FUNCIÓN DE CÁLCULO V DE AIKEN ---
        btnCalcular.addEventListener('click', () => {
            spinner.style.display = 'flex';
            resultadosContainer.innerHTML = '';
            btnDescargarPDF.classList.add('hidden');

            setTimeout(() => {
                try {
                    const numJueces = parseInt(numJuecesEl.value);
                    if (escalaOpciones.length < 2) throw new Error("La escala de valoración debe tener al menos dos opciones.");

                    const inputs = tablaContainer.querySelectorAll('input[type="number"]');
                    if(inputs.length === 0) throw new Error("Primero debe generar la tabla y rellenar los datos.");

                    const valoresEscala = escalaOpciones.map(opc => opc.valor);
                    const validValues = new Set(valoresEscala);
                    const l = Math.min(...valoresEscala);
                    const k = Math.max(...valoresEscala) - l;
                    if (k <= 0) throw new Error("El rango de la escala (valor máximo - valor mínimo) debe ser mayor que cero.");

                    let resultados = [];
                    const numItems = parseInt(numItemsEl.value);

                    for (let i = 1; i <= numItems; i++) {
                        let suma = 0;
                        for (let j = 1; j <= numJueces; j++) {
                            const input = tablaContainer.querySelector(`input[data-item="${i}"][data-juez="${j}"]`);
                            if (!input || input.value.trim() === '') {
                                throw new Error(`Faltan datos para el Ítem ${i} / Juez ${j}. Por favor, complete todas las casillas.`);
                            }

                            const valorIngresado = parseFloat(input.value);
                            if (isNaN(valorIngresado)) {
                                throw new Error(`El valor ingresado para el Ítem ${i} / Juez ${j} no es un número válido.`);
                            }

                            if (!validValues.has(valorIngresado)) {
                                const permitidos = [...validValues].sort((a,b) => a-b).join(', ');
                                throw new Error(`El valor "${valorIngresado}" para el Ítem ${i} / Juez ${j} no es válido. Valores permitidos: ${permitidos}.`);
                            }

                            suma += valorIngresado;
                        }

                        const promedio = suma / numJueces;
                        const vAiken = (promedio - l) / k;
                        resultados.push({ item: i, promedio: promedio.toFixed(2), v: vAiken.toFixed(3) });
                    }
                    mostrarResultados(resultados);

                } catch (error) {
                    resultadosContainer.innerHTML = `<p class="text-red-600 font-semibold p-4 bg-red-100 rounded-md"><i class="fas fa-exclamation-circle mr-2"></i>${error.message}</p>`;
                } finally {
                    spinner.style.display = 'none';
                }
            }, 500);
        });

        // --- FUNCIÓN PARA MOSTRAR RESULTADOS ---
        const getInterpretacion = (v) => {
            const val = parseFloat(v);
            if (val >= 0.80) return { texto: 'Ítem Válido', color: 'bg-emerald-100 text-emerald-800' };
            if (val >= 0.70) return { texto: 'Ítem Aceptable', color: 'bg-sky-100 text-sky-800' };
            if (val >= 0.60) return { texto: 'Revisar Ítem', color: 'bg-amber-100 text-amber-800' };
            return { texto: 'Eliminar Ítem', color: 'bg-red-100 text-red-800' };
        };

        const mostrarResultados = (resultados) => {
            let tableHTML = '<table class="min-w-full divide-y divide-slate-200 border border-slate-200"><thead><tr class="bg-slate-50">';
            tableHTML += '<th class="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Ítem</th>';
            tableHTML += '<th class="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Promedio</th>';
            tableHTML += '<th class="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">V de Aiken</th>';
            tableHTML += '<th class="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Interpretación</th>';
            tableHTML += '</tr></thead><tbody class="bg-white divide-y divide-slate-200">';

            resultados.forEach(res => {
                const interpretacion = getInterpretacion(res.v);
                tableHTML += `<tr>`;
                tableHTML += `<td class="px-4 py-2 whitespace-nowrap font-medium text-sm">Ítem ${res.item}</td>`;
                tableHTML += `<td class="px-4 py-2 whitespace-nowrap text-sm">${res.promedio}</td>`;
                tableHTML += `<td class="px-4 py-2 whitespace-nowrap text-sm font-bold">${res.v}</td>`;
                tableHTML += `<td class="px-4 py-2 whitespace-nowrap text-sm"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${interpretacion.color}">${interpretacion.texto}</span></td>`;
                tableHTML += `</tr>`;
            });

            tableHTML += '</tbody></table>';
            resultadosContainer.innerHTML = tableHTML;
            btnDescargarPDF.classList.remove('hidden');
        };

        // --- FUNCIÓN PARA DESCARGAR PDF ---
        btnDescargarPDF.addEventListener('click', () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFontSize(18);
            doc.text("Resultados del Análisis V de Aiken", 14, 22);
            doc.setFontSize(11);
            doc.setTextColor(100);
            doc.text(`Número de Jueces: ${numJuecesEl.value}`, 14, 32);
            doc.text(`Número de Ítems: ${numItemsEl.value}`, 14, 38);
            let escalaTexto = "Escala de Valoración: ";
            escalaOpciones.forEach(opc => escalaTexto += `${opc.texto} (${opc.valor}); `);
            doc.text(escalaTexto, 14, 44, { maxWidth: 180 });
            const table = resultadosContainer.querySelector('table');
            doc.autoTable({ html: table, startY: 55, theme: 'grid', headStyles: { fillColor: [74, 85, 104] } });
            doc.save('resultados-V-de-Aiken.pdf');
        });

        // --- FUNCIONES DE GUARDADO Y CARGA ---
        btnGuardar.addEventListener('click', () => {
            const dataToSave = {
                numJueces: numJuecesEl.value,
                numItems: numItemsEl.value,
                escala: escalaOpciones,
                valoresTabla: []
            };
            const inputs = tablaContainer.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                dataToSave.valoresTabla.push({ item: input.dataset.item, juez: input.dataset.juez, value: input.value });
            });
            localStorage.setItem('aikenData', JSON.stringify(dataToSave));
            alert('¡Progreso guardado en el navegador!');
        });

        btnCargar.addEventListener('click', () => {
            const savedData = localStorage.getItem('aikenData');
            if (savedData) {
                const data = JSON.parse(savedData);
                numJuecesEl.value = data.numJueces;
                numItemsEl.value = data.numItems;
                escalaOpciones = data.escala;
                renderizarEscala();
                generarTabla();
                data.valoresTabla.forEach(val => {
                    const input = tablaContainer.querySelector(`input[data-item="${val.item}"][data-juez="${val.juez}"]`);
                    if(input) input.value = val.value;
                });
                alert('¡Progreso cargado!');
            } else {
                alert('No se encontró progreso guardado.');
            }
        });

        btnLimpiar.addEventListener('click', () => {
            if (confirm('¿Estás seguro de que quieres limpiar todos los datos y configuraciones?')) {
                localStorage.removeItem('aikenData');
                location.reload();
            }
        });

        // Inicializar la app
        renderizarEscala();
    });
</script>
</body>
</html>